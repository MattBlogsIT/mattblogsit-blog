name: Lighthouse CI

on:
  pull_request:
    branches:
      - main

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x

      - name: Build Jekyll site
        run: |
          bundle install
          JEKYLL_ENV=production bundle exec jekyll build --baseurl ""

      - name: Verify build output
        run: |
          echo "Checking _site directory contents..."
          ls -la _site/
          echo ""
          echo "Checking for HTML files..."
          find _site -name "*.html" | head -10
          echo ""
          echo "Build verification complete"

      - name: Run Lighthouse CI
        run: |
          mkdir -p .lighthouseci
          lhci autorun --verbose || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse and post Lighthouse results
        if: always()
        run: |
          echo "# ðŸ”¦ Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if results exist
          if [ ! -d ".lighthouseci" ] || [ -z "$(ls -A .lighthouseci 2>/dev/null)" ]; then
            echo "âŒ No Lighthouse results found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Lighthouse CI run may have failed. Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Find the manifest file
          MANIFEST=".lighthouseci/manifest.json"
          if [ ! -f "$MANIFEST" ]; then
            echo "âš ï¸ Lighthouse ran but no manifest found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Files in .lighthouseci/:" >> $GITHUB_STEP_SUMMARY
            ls -la .lighthouseci/ >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Parse results from JSON files
          echo "## ðŸ“Š Performance Scores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Page | Performance | Accessibility | Best Practices | SEO |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|---------------|----------------|-----|" >> $GITHUB_STEP_SUMMARY

          # Process each lighthouse report
          for report in .lighthouseci/lhr-*.json; do
            if [ -f "$report" ]; then
              # Extract scores using node
              node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('$report', 'utf8'));
                const url = data.finalUrl || data.requestedUrl || 'Unknown';
                const pageName = url.split('/').filter(p => p).pop() || 'Homepage';

                const perf = Math.round(data.categories.performance.score * 100);
                const a11y = Math.round(data.categories.accessibility.score * 100);
                const bp = Math.round(data.categories['best-practices'].score * 100);
                const seo = Math.round(data.categories.seo.score * 100);

                const getEmoji = (score) => score >= 90 ? 'ðŸŸ¢' : score >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';

                console.log(\`| \${pageName} | \${getEmoji(perf)} \${perf}% | \${getEmoji(a11y)} \${a11y}% | \${getEmoji(bp)} \${bp}% | \${getEmoji(seo)} \${seo}% |\`);
              " >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Legend:** ðŸŸ¢ Good (90+) | ðŸŸ¡ Needs Improvement (50-89) | ðŸ”´ Poor (0-49)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Full results available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30
          if-no-files-found: warn

name: Lighthouse CI

on:
  pull_request:
    branches:
      - main

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x

      - name: Build Jekyll site
        run: |
          bundle install
          JEKYLL_ENV=production bundle exec jekyll build --baseurl ""

      - name: Verify build output
        run: |
          echo "Checking _site directory contents..."
          ls -la _site/
          echo ""
          echo "Checking for HTML files..."
          find _site -name "*.html" | head -10
          echo ""
          echo "Build verification complete"

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        run: |
          echo "Starting Lighthouse CI..."
          mkdir -p .lighthouseci

          echo "Step 1: Collect Lighthouse data..."
          lhci collect --config=lighthouserc.json || echo "Collect failed with exit code $?"

          echo "Step 2: Assert against budgets..."
          lhci assert --config=lighthouserc.json || echo "Assert failed with exit code $?"

          echo "Step 3: Upload results..."
          lhci upload --config=lighthouserc.json || echo "Upload failed with exit code $?"

          echo "Lighthouse CI complete."
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Lighthouse output
        if: always()
        run: |
          echo "=== Lighthouse CI Output Check ==="
          if [ -d ".lighthouseci" ]; then
            echo "âœ“ .lighthouseci directory exists"
            echo "Contents:"
            ls -lah .lighthouseci/ || echo "Directory is empty or inaccessible"
            echo ""
            echo "File count: $(find .lighthouseci -type f 2>/dev/null | wc -l)"
            echo ""
            if [ -n "$(ls -A .lighthouseci 2>/dev/null)" ]; then
              echo "Files found:"
              find .lighthouseci -type f -exec echo "  - {}" \;
            else
              echo "âŒ No files generated in .lighthouseci directory"
              echo "Lighthouse CI likely failed to run. Check the 'Run Lighthouse CI' step above."
            fi
          else
            echo "âŒ .lighthouseci directory does not exist"
            echo "Lighthouse CI did not create any output."
          fi
          echo "==================================="

      - name: Parse and post Lighthouse results
        if: always() && hashFiles('.lighthouseci/*.json') != ''
        run: |
          echo "# ðŸ”¦ Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if reports exist
          REPORT_COUNT=$(find .lighthouseci -name "lhr-*.json" 2>/dev/null | wc -l)
          if [ "$REPORT_COUNT" -eq 0 ]; then
            echo "âŒ No Lighthouse reports found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Lighthouse CI run failed. Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "## ðŸ“Š Performance Scores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Page | Performance | Accessibility | Best Practices | SEO |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|---------------|----------------|-----|" >> $GITHUB_STEP_SUMMARY

          # Process each lighthouse report
          for report in .lighthouseci/lhr-*.json; do
            if [ -f "$report" ]; then
              node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('$report', 'utf8'));
                const url = data.finalUrl || data.requestedUrl || 'Unknown';
                const pageName = url.split('/').filter(p => p).pop() || 'Homepage';

                const perf = Math.round(data.categories.performance.score * 100);
                const a11y = Math.round(data.categories.accessibility.score * 100);
                const bp = Math.round(data.categories['best-practices'].score * 100);
                const seo = Math.round(data.categories.seo.score * 100);

                const getEmoji = (score) => score >= 90 ? 'ðŸŸ¢' : score >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';

                console.log(\`| \${pageName} | \${getEmoji(perf)} \${perf}% | \${getEmoji(a11y)} \${a11y}% | \${getEmoji(bp)} \${bp}% | \${getEmoji(seo)} \${seo}% |\`);
              " >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Legend:** ðŸŸ¢ Good (90+) | ðŸŸ¡ Needs Improvement (50-89) | ðŸ”´ Poor (0-49)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Full results available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('.lighthouseci/*.json') != ''
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

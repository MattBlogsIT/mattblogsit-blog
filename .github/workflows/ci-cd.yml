# Production Deployment Pipeline  
name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Production deployment - validation already done in PR
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Generate dynamic pages
        run: |
          echo "ğŸ“„ Generating dynamic pages..."
          mkdir -p archive category
          
          # Create archive pages for each year
          for year in $(grep -h "^date:" _posts/*.md | sed 's/date: //' | cut -d'-' -f1 | sort -u); do
            mkdir -p "archive/$year"
            {
              echo "---"
              echo "layout: archive"
              echo "year: \"$year\""
              echo "title: $year Archive"
              echo "permalink: /archive/$year/"
              echo "---"
            } > "archive/$year/index.md"
          done
          
          # Create category pages
          for category in $(grep -h -A5 "^categories:" _posts/*.md | grep "^-" | sed 's/^- //' | sed 's/"//g' | sort -u); do
            slug=$(echo "$category" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
            mkdir -p "category/$slug"
            {
              echo "---"
              echo "layout: category"
              echo "category: \"$category\""
              echo "title: $category Posts"
              echo "permalink: /category/$slug/"
              echo "---"
            } > "category/$slug/index.md"
          done
          
          echo "âœ… Dynamic pages generated"

      - name: Build Jekyll site
        run: |
          echo "ğŸ”¨ Building production site..."
          bundle exec jekyll build --baseurl "/mattblogsit-dev"
          echo "âœ… Production build complete"
        env:
          JEKYLL_ENV: production

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post-deployment verification
        run: |
          echo "âœ… Deployment completed successfully"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“Š Deployment info available in GitHub Pages settings"
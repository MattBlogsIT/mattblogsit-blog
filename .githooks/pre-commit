#!/bin/bash

# Pre-commit hook for image validation
# Prevents commits with oversized images

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
MAX_SIZE_KB=500
MAX_WIDTH=2000

# Get staged image files
STAGED_IMAGES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(jpg|jpeg|png|gif)$')

if [ -z "$STAGED_IMAGES" ]; then
    # No images staged, continue
    exit 0
fi

echo -e "${YELLOW}ğŸ–¼ï¸  Validating staged images...${NC}"
echo ""

# Check if ImageMagick is installed
if ! command -v identify &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  ImageMagick not installed - skipping image validation${NC}"
    echo -e "${YELLOW}   Install: brew install imagemagick (macOS) or apt-get install imagemagick (Linux)${NC}"
    exit 0
fi

# Function to get file size in KB
get_size_kb() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        stat -f%z "$1" | awk '{print int($1/1024)}'
    else
        # Linux
        stat -c%s "$1" | awk '{print int($1/1024)}'
    fi
}

# Check each staged image
VIOLATIONS=0
WARNINGS=0

for file in $STAGED_IMAGES; do
    if [ ! -f "$file" ]; then
        continue
    fi

    filename=$(basename "$file")
    size_kb=$(get_size_kb "$file")

    # Get dimensions
    dimensions=$(identify -format "%wx%h" "$file" 2>/dev/null)
    width=$(identify -format "%w" "$file" 2>/dev/null)

    # Check size
    if [ "$size_kb" -gt "$MAX_SIZE_KB" ]; then
        echo -e "${RED}âŒ $filename: ${size_kb}KB (exceeds ${MAX_SIZE_KB}KB limit)${NC}"
        echo -e "   Dimensions: $dimensions"
        echo -e "   ${YELLOW}Optimize with: ./scripts/optimize-images.sh${NC}"
        echo ""
        VIOLATIONS=$((VIOLATIONS + 1))
    elif [ "$size_kb" -gt 300 ]; then
        echo -e "${YELLOW}âš ï¸  $filename: ${size_kb}KB (consider optimizing)${NC}"
        echo -e "   Dimensions: $dimensions"
        echo ""
        WARNINGS=$((WARNINGS + 1))
    else
        echo -e "${GREEN}âœ“ $filename: ${size_kb}KB${NC}"
    fi

    # Check width
    if [ "$width" -gt "$MAX_WIDTH" ]; then
        echo -e "${YELLOW}âš ï¸  $filename: width ${width}px (consider resizing to ${MAX_WIDTH}px)${NC}"
        echo ""
        WARNINGS=$((WARNINGS + 1))
    fi
done

echo ""

# Handle violations
if [ "$VIOLATIONS" -gt 0 ]; then
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}COMMIT BLOCKED: ${VIOLATIONS} image(s) exceed size limit${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}To fix:${NC}"
    echo -e "  1. Run: ${GREEN}./scripts/optimize-images.sh${NC}"
    echo -e "  2. Review optimized images"
    echo -e "  3. Stage changes: ${GREEN}git add assets/img${NC}"
    echo -e "  4. Commit again: ${GREEN}git commit${NC}"
    echo ""
    echo -e "${YELLOW}To bypass this check (not recommended):${NC}"
    echo -e "  ${GREEN}git commit --no-verify${NC}"
    echo ""
    exit 1
fi

# Handle warnings
if [ "$WARNINGS" -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  ${WARNINGS} image(s) could be optimized for better performance${NC}"
    echo -e "   Run: ${GREEN}./scripts/optimize-images.sh${NC}"
    echo ""
fi

echo -e "${GREEN}âœ“ All images pass validation${NC}"
exit 0
